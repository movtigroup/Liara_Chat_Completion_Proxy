
2025-06-30 09:59:12.751 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 09:59:12.753 | WARNING  | main:http_exception_handler:109 - HTTPException: API Key is required in Authorization header
2025-06-30 09:59:12.754 | INFO     | main:dispatch:100 - Response: 401 (2.44ms)
2025-06-30 09:59:12.759 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 09:59:12.761 | WARNING  | main:http_exception_handler:109 - HTTPException: API Key is required in Authorization header
2025-06-30 09:59:12.761 | INFO     | main:dispatch:100 - Response: 401 (1.50ms)
2025-06-30 09:59:12.768 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 09:59:12.818 | INFO     | main:dispatch:100 - Response: 200 (50.33ms)
2025-06-30 09:59:12.824 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 09:59:12.826 | INFO     | main:chat_completions:137 - Cache hit
2025-06-30 09:59:12.826 | INFO     | main:dispatch:100 - Response: 200 (1.87ms)
2025-06-30 09:59:12.903 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 09:59:13.026 | WARNING  | main:http_exception_handler:109 - HTTPException: All upstream servers are unavailable
2025-06-30 09:59:13.027 | INFO     | main:dispatch:100 - Response: 502 (123.65ms)
2025-06-30 09:59:13.045 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 09:59:13.086 | INFO     | main:dispatch:100 - Response: 200 (40.68ms)
2025-06-30 09:59:13.091 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 09:59:43.161 | WARNING  | main:chat_completions:160 - Connection failed to https://ai.liara.ir/api/v1/682bb6c5009ad8b844028900:
2025-06-30 10:00:13.229 | WARNING  | main:chat_completions:160 - Connection failed to https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d300:
2025-06-30 10:00:43.298 | WARNING  | main:chat_completions:160 - Connection failed to https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d300:
2025-06-30 10:00:43.299 | WARNING  | main:http_exception_handler:109 - HTTPException: All upstream servers are unavailable
2025-06-30 10:00:43.300 | INFO     | main:dispatch:100 - Response: 502 (90208.69ms)
2025-06-30 10:00:43.316 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 10:00:43.317 | INFO     | main:dispatch:100 - Response: 422 (1.38ms)
2025-06-30 10:00:43.322 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 10:00:43.324 | WARNING  | main:http_exception_handler:109 - HTTPException: All upstream servers are unavailable
2025-06-30 10:00:43.324 | INFO     | main:dispatch:100 - Response: 502 (1.86ms)
2025-06-30 10:00:43.329 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 10:00:43.369 | INFO     | main:dispatch:100 - Response: 200 (39.94ms)
2025-06-30 10:00:43.375 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 10:00:43.416 | INFO     | main:dispatch:100 - Response: 200 (40.75ms)
2025-06-30 10:00:43.419 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 10:00:43.459 | INFO     | main:dispatch:100 - Response: 200 (39.71ms)
2025-06-30 10:01:16.031 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 10:01:16.034 | WARNING  | main:http_exception_handler:109 - HTTPException: API Key is required in Authorization header
2025-06-30 10:01:16.034 | INFO     | main:dispatch:100 - Response: 401 (2.28ms)
2025-06-30 10:01:16.039 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 10:01:16.040 | WARNING  | main:http_exception_handler:109 - HTTPException: API Key is required in Authorization header
2025-06-30 10:01:16.041 | INFO     | main:dispatch:100 - Response: 401 (1.48ms)
2025-06-30 10:01:16.047 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 10:01:16.093 | INFO     | main:dispatch:100 - Response: 200 (45.67ms)
2025-06-30 10:01:16.099 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 10:01:16.101 | INFO     | main:chat_completions:137 - Cache hit
2025-06-30 10:01:16.101 | INFO     | main:dispatch:100 - Response: 200 (2.13ms)
2025-06-30 10:01:16.106 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 10:01:16.147 | WARNING  | main:chat_completions:160 - Connection failed to https://ai.liara.ir/api/v1/682bb6c5009ad8b844028900: Connection failed to first server
2025-06-30 10:01:16.197 | INFO     | main:dispatch:100 - Response: 200 (90.88ms)
2025-06-30 10:01:16.205 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 10:01:16.245 | WARNING  | main:chat_completions:160 - Connection failed to https://ai.liara.ir/api/v1/682bb6c5009ad8b844028900: Connection failed to server 0
2025-06-30 10:01:16.285 | WARNING  | main:chat_completions:160 - Connection failed to https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d300: Connection failed to server 1
2025-06-30 10:01:16.325 | WARNING  | main:chat_completions:160 - Connection failed to https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d300: Connection failed to server 2
2025-06-30 10:01:16.326 | WARNING  | main:http_exception_handler:109 - HTTPException: All upstream servers are unavailable
2025-06-30 10:01:16.326 | INFO     | main:dispatch:100 - Response: 502 (121.19ms)
2025-06-30 10:01:16.332 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 10:01:16.469 | WARNING  | main:http_exception_handler:109 - HTTPException: All upstream servers are unavailable
2025-06-30 10:01:16.470 | INFO     | main:dispatch:100 - Response: 502 (137.24ms)
2025-06-30 10:01:16.479 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 10:01:16.519 | INFO     | main:dispatch:100 - Response: 503 (39.90ms)
2025-06-30 10:01:16.525 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 10:01:16.566 | INFO     | main:dispatch:100 - Response: 200 (40.35ms)
2025-06-30 10:01:16.570 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 10:01:16.572 | INFO     | main:dispatch:100 - Response: 422 (1.27ms)
2025-06-30 10:01:16.575 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 10:01:16.577 | INFO     | main:dispatch:100 - Response: 422 (1.10ms)
2025-06-30 10:01:16.586 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 10:01:16.588 | WARNING  | main:http_exception_handler:109 - HTTPException: All upstream servers are unavailable
2025-06-30 10:01:16.588 | INFO     | main:dispatch:100 - Response: 502 (1.83ms)
2025-06-30 10:01:16.593 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 10:01:16.634 | INFO     | main:dispatch:100 - Response: 200 (40.61ms)
2025-06-30 10:01:16.639 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 10:01:16.682 | INFO     | main:dispatch:100 - Response: 200 (42.30ms)
2025-06-30 10:01:16.685 | INFO     | main:dispatch:88 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 10:01:16.726 | INFO     | main:dispatch:100 - Response: 200 (40.04ms)
2025-06-30 11:03:40.314 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:03:40.317 | WARNING  | main:http_exception_handler:116 - HTTPException: API Key is required in Authorization header
2025-06-30 11:03:40.317 | INFO     | main:dispatch:107 - Response: 401 (2.94ms)
2025-06-30 11:03:40.323 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:03:40.324 | WARNING  | main:http_exception_handler:116 - HTTPException: API Key is required in Authorization header
2025-06-30 11:03:40.325 | INFO     | main:dispatch:107 - Response: 401 (1.48ms)
2025-06-30 11:03:40.330 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:03:40.385 | INFO     | main:dispatch:107 - Response: 200 (54.16ms)
2025-06-30 11:03:40.391 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:03:40.392 | INFO     | main:chat_completions:144 - Cache hit
2025-06-30 11:03:40.393 | INFO     | main:dispatch:107 - Response: 200 (1.70ms)
2025-06-30 11:03:40.397 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:03:40.436 | WARNING  | main:chat_completions:181 - Could not connect to upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b844028900: Connection failed to first server
2025-06-30 11:03:40.486 | INFO     | main:dispatch:107 - Response: 200 (89.08ms)
2025-06-30 11:03:40.493 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:03:40.532 | WARNING  | main:chat_completions:181 - Could not connect to upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b844028900: Connection failed to server 0
2025-06-30 11:03:40.572 | WARNING  | main:chat_completions:181 - Could not connect to upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d300: Connection failed to server 1
2025-06-30 11:03:40.611 | WARNING  | main:chat_completions:181 - Could not connect to upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d300: Connection failed to server 2
2025-06-30 11:03:40.611 | WARNING  | main:http_exception_handler:116 - HTTPException: Could not connect to AI service endpoint: https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d300. It may be temporarily down.
2025-06-30 11:03:40.612 | INFO     | main:dispatch:107 - Response: 503 (118.16ms)
2025-06-30 11:03:40.617 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:03:40.657 | WARNING  | main:chat_completions:164 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b844028900 returned error: 429 - Liara specific error
2025-06-30 11:03:40.705 | WARNING  | main:chat_completions:164 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d300 returned error: 429 - Liara specific error
2025-06-30 11:03:40.745 | WARNING  | main:chat_completions:164 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d300 returned error: 429 - Liara specific error
2025-06-30 11:03:40.746 | WARNING  | main:http_exception_handler:116 - HTTPException: An unexpected error occurred while contacting AI service: https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d300.
2025-06-30 11:03:40.746 | INFO     | main:dispatch:107 - Response: 500 (128.79ms)
2025-06-30 11:03:40.827 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:03:40.867 | ERROR    | main:dispatch:101 - Unhandled exception: UpstreamResponseError.__init__() got an unexpected keyword argument 'upstream_status_code'
Traceback (most recent call last):

  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    message = await recv_stream.receive()
                    │           └ <function MemoryObjectReceiveStream.receive at 0x7efd8bde02c0>
                    └ MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_rece...
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/streams/memory.py", line 126, in receive
    raise EndOfStream from None
          └ <class 'anyio.EndOfStream'>

anyio.EndOfStream


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1032, in _bootstrap
    self._bootstrap_inner()
    │    └ <function Thread._bootstrap_inner at 0x7efd8cc80b80>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1075, in _bootstrap_inner
    self.run()
    │    └ <function Thread.run at 0x7efd8cc80860>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1012, in run
    self._target(*self._args, **self._kwargs)
    │    │        │    │        │    └ {}
    │    │        │    │        └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
    │    │        │    └ ()
    │    │        └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
    │    └ <function start_blocking_portal.<locals>.run_blocking_portal at 0x7efd8ab56ca0>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/from_thread.py", line 481, in run_blocking_portal
    _eventloop.run(
    │          └ <function run at 0x7efd8c595bc0>
    └ <module 'anyio._core._eventloop' from '/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_core/_eventloo...
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_core/_eventloop.py", line 74, in run
    return async_backend.run(func, args, {}, backend_options)
           │             │   │     │         └ {}
           │             │   │     └ ()
           │             │   └ <function start_blocking_portal.<locals>.run_portal at 0x7efd8ab56c00>
           │             └ <classmethod(<function AsyncIOBackend.run at 0x7efd8abbf2e0>)>
           └ <class 'anyio._backends._asyncio.AsyncIOBackend'>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2310, in run
    return runner.run(wrapper())
           │      │   └ <function start_blocking_portal.<locals>.run_portal at 0x7efd8ab56de0>
           │      └ <function Runner.run at 0x7efd8bd73b00>
           └ <asyncio.runners.Runner object at 0x7efd8ab5c1d0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='anyio.from_thread.start_blocking_portal.<locals>.run_portal' coro=<start_blocking_portal.<locals>.run_por...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7efd8bd716c0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7efd8ab5c1d0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 678, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7efd8bd71620>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 645, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7efd8bd73420>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 1999, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7efd8bcf3d80>
    └ <Handle Task.task_wakeup(<Future finished result=True>)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/events.py", line 88, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle Task.task_wakeup(<Future finished result=True>)>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle Task.task_wakeup(<Future finished result=True>)>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle Task.task_wakeup(<Future finished result=True>)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
                   └ <coroutine object FastAPI.__call__ at 0x7efd8ab17790>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <function _TestClientTransport.handle_request.<locals>.send at 0x7efd8ab656c0>
                           │      └ <function _TestClientTransport.handle_request.<locals>.receive at 0x7efd8ab66020>
                           └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function _TestClientTransport.handle_request.<locals>.send at 0x7efd8ab656c0>
          │    │                │      └ <function _TestClientTransport.handle_request.<locals>.receive at 0x7efd8ab66020>
          │    │                └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7efd8ab62e70>
          └ <fastapi.applications.FastAPI object at 0x7efd8ac9bf50>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7efd8ab67100>
          │    │   │      └ <function _TestClientTransport.handle_request.<locals>.receive at 0x7efd8ab66020>
          │    │   └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
          │    └ <main.LoggingMiddleware object at 0x7efd8ab62e40>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7efd8ab62e70>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    response = await self.dispatch_func(request, call_next)
                     │    │             │        └ <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7efd8ab66de0>
                     │    │             └ <starlette.middleware.base._CachedRequest object at 0x7efd8aa9b350>
                     │    └ <bound method LoggingMiddleware.dispatch of <main.LoggingMiddleware object at 0x7efd8ab62e40>>
                     └ <main.LoggingMiddleware object at 0x7efd8ab62e40>

> File "/app/main.py", line 99, in dispatch
    response = await call_next(request)
                     │         └ <starlette.middleware.base._CachedRequest object at 0x7efd8aa9b350>
                     └ <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7efd8ab66de0>

  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/base.py", line 165, in call_next
    raise app_exc
          └ TypeError("UpstreamResponseError.__init__() got an unexpected keyword argument 'upstream_status_code'")
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/base.py", line 151, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
          │    │   │      │                      └ <function BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.send_no_error at 0x7efd8ab67420>
          │    │   │      └ <function BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.receive_or_disconnect at 0x7efd8ab66980>
          │    │   └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7efd8ab62e10>
          └ <main.LoggingMiddleware object at 0x7efd8ab62e40>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ <function BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.send_no_error at 0x7efd8ab67420>
          │                            │    │    │     │      └ <function BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.receive_or_disconnect at 0x7efd8ab66980>
          │                            │    │    │     └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
          │                            │    │    └ <starlette.requests.Request object at 0x7efd8aa9b710>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7efd8ab62e10>
          └ <function wrap_app_handling_exceptions at 0x7efd8ae805e0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 64, in wrapped_app
    raise exc
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8aa89260>
          │   │      └ <function BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.receive_or_disconnect at 0x7efd8ab66980>
          │   └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
          └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8aa89260>
          │    │                │      └ <function BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.receive_or_disconnect at 0x7efd8ab66980>
          │    │                └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7efd8acc75c0>>
          └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8aa89260>
          │     │      │      └ <function BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.receive_or_disconnect at 0x7efd8ab66980>
          │     │      └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
          │     └ <function Route.handle at 0x7efd8ae81a80>
          └ APIRoute(path='/api/v1/chat/completions', name='chat_completions', methods=['POST'])
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8aa89260>
          │    │   │      └ <function BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.receive_or_disconnect at 0x7efd8ab66980>
          │    │   └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
          │    └ <function request_response.<locals>.app at 0x7efd8ab1e3e0>
          └ APIRoute(path='/api/v1/chat/completions', name='chat_completions', methods=['POST'])
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8aa89260>
          │                            │    │        │      └ <function BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.receive_or_disconnect at 0x7efd8ab66980>
          │                            │    │        └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
          │                            │    └ <starlette.requests.Request object at 0x7efd8aa9b920>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7efd8aa89300>
          └ <function wrap_app_handling_exceptions at 0x7efd8ae805e0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 64, in wrapped_app
    raise exc
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8aa89440>
          │   │      └ <function BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.receive_or_disconnect at 0x7efd8ab66980>
          │   └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
          └ <function request_response.<locals>.app.<locals>.app at 0x7efd8aa89300>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7efd8aa9b920>
                     └ <function get_request_handler.<locals>.app at 0x7efd8ab1e520>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7efd8ae80180>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'body': CompletionRequest(model='openai/gpt-4o-mini', messages=[Message(role='user', content='Hello', name=None, tool_calls=...
                 │         └ <function chat_completions at 0x7efd8ab1e5c0>
                 └ <fastapi.dependencies.models.Dependant object at 0x7efd8ab0afc0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/slowapi/extension.py", line 730, in async_wrapper
    response = await func(*args, **kwargs)  # type: ignore
                     │     │       └ {'body': CompletionRequest(model='openai/gpt-4o-mini', messages=[Message(role='user', content='Hello', name=None, tool_calls=...
                     │     └ ()
                     └ <function chat_completions at 0x7efd8ab1e480>

  File "/app/main.py", line 187, in chat_completions
    last_exception = UpstreamResponseError(
                     └ <class 'errors.UpstreamResponseError'>

TypeError: UpstreamResponseError.__init__() got an unexpected keyword argument 'upstream_status_code'
2025-06-30 11:03:40.930 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:03:40.971 | INFO     | main:dispatch:107 - Response: 200 (40.62ms)
2025-06-30 11:03:40.975 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:03:40.978 | INFO     | main:dispatch:107 - Response: 422 (2.05ms)
2025-06-30 11:03:40.981 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:03:40.982 | INFO     | main:dispatch:107 - Response: 422 (0.69ms)
2025-06-30 11:03:40.987 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:03:40.989 | WARNING  | main:http_exception_handler:116 - HTTPException: All AI service endpoints are currently unavailable or failed.
2025-06-30 11:03:40.989 | INFO     | main:dispatch:107 - Response: 503 (1.82ms)
2025-06-30 11:03:40.994 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:03:41.034 | INFO     | main:dispatch:107 - Response: 200 (39.61ms)
2025-06-30 11:03:41.039 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:03:41.080 | INFO     | main:dispatch:107 - Response: 200 (40.45ms)
2025-06-30 11:03:41.083 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:03:41.123 | INFO     | main:dispatch:107 - Response: 200 (39.34ms)
2025-06-30 11:03:41.181 | ERROR    | main:websocket_chat:275 - WS: Unexpected error with AI service at ai.liara.ir during stream: 'coroutine' object does not support the asynchronous context manager protocol
2025-06-30 11:03:41.182 | ERROR    | main:websocket_chat:299 - General WebSocket error for 0722eeda-0f79-4ab6-8222-a1a04477a160: name 'UpstreamServiceError' is not defined
Traceback (most recent call last):

  File "/app/main.py", line 241, in websocket_chat
    async with client.stream(
               │      └ <AsyncMock id='139627419464720'>
               └ <httpx.AsyncClient object at 0x7efd89741eb0>

TypeError: 'coroutine' object does not support the asynchronous context manager protocol


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1032, in _bootstrap
    self._bootstrap_inner()
    │    └ <function Thread._bootstrap_inner at 0x7efd8cc80b80>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1075, in _bootstrap_inner
    self.run()
    │    └ <function Thread.run at 0x7efd8cc80860>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1012, in run
    self._target(*self._args, **self._kwargs)
    │    │        │    │        │    └ {}
    │    │        │    │        └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
    │    │        │    └ ()
    │    │        └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
    │    └ <function start_blocking_portal.<locals>.run_blocking_portal at 0x7efd8ab56ca0>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/from_thread.py", line 481, in run_blocking_portal
    _eventloop.run(
    │          └ <function run at 0x7efd8c595bc0>
    └ <module 'anyio._core._eventloop' from '/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_core/_eventloo...
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_core/_eventloop.py", line 74, in run
    return async_backend.run(func, args, {}, backend_options)
           │             │   │     │         └ {}
           │             │   │     └ ()
           │             │   └ <function start_blocking_portal.<locals>.run_portal at 0x7efd8ab56c00>
           │             └ <classmethod(<function AsyncIOBackend.run at 0x7efd8abbf2e0>)>
           └ <class 'anyio._backends._asyncio.AsyncIOBackend'>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2310, in run
    return runner.run(wrapper())
           │      │   └ <function start_blocking_portal.<locals>.run_portal at 0x7efd8ab56de0>
           │      └ <function Runner.run at 0x7efd8bd73b00>
           └ <asyncio.runners.Runner object at 0x7efd8ab5c1d0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='anyio.from_thread.start_blocking_portal.<locals>.run_portal' coro=<start_blocking_portal.<locals>.run_por...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7efd8bd716c0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7efd8ab5c1d0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 678, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7efd8bd71620>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 645, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7efd8bd73420>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 1999, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7efd8bcf3d80>
    └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd89741db0>()>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/events.py", line 88, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd89741db0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd89741db0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd89741db0>()>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/testclient.py", line 137, in run_app
    await self.app(self.scope, self._asgi_receive, self._asgi_send)
          │    │   │    │      │    │              │    └ <function WebSocketTestSession._asgi_send at 0x7efd8aefaa20>
          │    │   │    │      │    │              └ <starlette.testclient.WebSocketTestSession object at 0x7efd89740710>
          │    │   │    │      │    └ <function WebSocketTestSession._asgi_receive at 0x7efd8aefa980>
          │    │   │    │      └ <starlette.testclient.WebSocketTestSession object at 0x7efd89740710>
          │    │   │    └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    │   └ <starlette.testclient.WebSocketTestSession object at 0x7efd89740710>
          │    └ <fastapi.applications.FastAPI object at 0x7efd8ac9bf50>
          └ <starlette.testclient.WebSocketTestSession object at 0x7efd89740710>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd89740710>>
                           │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89740710>>
                           └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd89740710>>
          │    │                │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89740710>>
          │    │                └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7efd8ab62e70>
          └ <fastapi.applications.FastAPI object at 0x7efd8ac9bf50>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/errors.py", line 151, in __call__
    await self.app(scope, receive, send)
          │    │   │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd89740710>>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89740710>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <main.LoggingMiddleware object at 0x7efd8ab62e40>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7efd8ab62e70>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/base.py", line 103, in __call__
    await self.app(scope, receive, send)
          │    │   │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd89740710>>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89740710>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7efd8ab62e10>
          └ <main.LoggingMiddleware object at 0x7efd8ab62e40>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd89740710>>
          │                            │    │    │     │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89740710>>
          │                            │    │    │     └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │                            │    │    └ <starlette.websockets.WebSocket object at 0x7efd897402c0>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7efd8ab62e10>
          └ <function wrap_app_handling_exceptions at 0x7efd8ae805e0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8ab67240>
          │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89740710>>
          │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8ab67240>
          │    │                │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89740710>>
          │    │                └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7efd8acc75c0>>
          └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8ab67240>
          │     │      │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89740710>>
          │     │      └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │     └ <function WebSocketRoute.handle at 0x7efd8ae81ee0>
          └ APIWebSocketRoute(path='/ws/v1/chat/completions', name='websocket_chat')
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 375, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8ab67240>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89740710>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <function websocket_session.<locals>.app at 0x7efd8ab1e700>
          └ APIWebSocketRoute(path='/ws/v1/chat/completions', name='websocket_chat')
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 98, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8ab67240>
          │                            │    │        │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89740710>>
          │                            │    │        └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │                            │    └ <starlette.websockets.WebSocket object at 0x7efd89740110>
          │                            └ <function websocket_session.<locals>.app.<locals>.app at 0x7efd8ab668e0>
          └ <function wrap_app_handling_exceptions at 0x7efd8ae805e0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8ab671a0>
          │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89740710>>
          │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          └ <function websocket_session.<locals>.app.<locals>.app at 0x7efd8ab668e0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 96, in app
    await func(session)
          │    └ <starlette.websockets.WebSocket object at 0x7efd89740110>
          └ <function get_websocket_app.<locals>.app at 0x7efd8ab1e7a0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/fastapi/routing.py", line 348, in app
    await dependant.call(**values)
          │         │      └ {'websocket': <starlette.websockets.WebSocket object at 0x7efd89740110>}
          │         └ <function websocket_chat at 0x7efd8ab1e660>
          └ <fastapi.dependencies.models.Dependant object at 0x7efd8ab0a930>

> File "/app/main.py", line 276, in websocket_chat
    if isinstance(e, UpstreamServiceError): # If it was already one of our custom types somehow
                  └ NameError("name 'UpstreamServiceError' is not defined")

NameError: name 'UpstreamServiceError' is not defined
2025-06-30 11:03:41.231 | ERROR    | main:websocket_chat:275 - WS: Unexpected error with AI service at ai.liara.ir during stream: 'coroutine' object does not support the asynchronous context manager protocol
2025-06-30 11:03:41.232 | ERROR    | main:websocket_chat:299 - General WebSocket error for b8bbb2a8-6126-4f5c-aa10-fe824b43b789: name 'UpstreamServiceError' is not defined
Traceback (most recent call last):

  File "/app/main.py", line 241, in websocket_chat
    async with client.stream(
               │      └ <AsyncMock id='139627419464720'>
               └ <httpx.AsyncClient object at 0x7efd89745cd0>

TypeError: 'coroutine' object does not support the asynchronous context manager protocol


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1032, in _bootstrap
    self._bootstrap_inner()
    │    └ <function Thread._bootstrap_inner at 0x7efd8cc80b80>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1075, in _bootstrap_inner
    self.run()
    │    └ <function Thread.run at 0x7efd8cc80860>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1012, in run
    self._target(*self._args, **self._kwargs)
    │    │        │    │        │    └ {}
    │    │        │    │        └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
    │    │        │    └ ()
    │    │        └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
    │    └ <function start_blocking_portal.<locals>.run_blocking_portal at 0x7efd8ab56ca0>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/from_thread.py", line 481, in run_blocking_portal
    _eventloop.run(
    │          └ <function run at 0x7efd8c595bc0>
    └ <module 'anyio._core._eventloop' from '/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_core/_eventloo...
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_core/_eventloop.py", line 74, in run
    return async_backend.run(func, args, {}, backend_options)
           │             │   │     │         └ {}
           │             │   │     └ ()
           │             │   └ <function start_blocking_portal.<locals>.run_portal at 0x7efd8ab56c00>
           │             └ <classmethod(<function AsyncIOBackend.run at 0x7efd8abbf2e0>)>
           └ <class 'anyio._backends._asyncio.AsyncIOBackend'>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2310, in run
    return runner.run(wrapper())
           │      │   └ <function start_blocking_portal.<locals>.run_portal at 0x7efd8ab56de0>
           │      └ <function Runner.run at 0x7efd8bd73b00>
           └ <asyncio.runners.Runner object at 0x7efd8ab5c1d0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='anyio.from_thread.start_blocking_portal.<locals>.run_portal' coro=<start_blocking_portal.<locals>.run_por...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7efd8bd716c0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7efd8ab5c1d0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 678, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7efd8bd71620>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 645, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7efd8bd73420>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 1999, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7efd8bcf3d80>
    └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd897409d0>()>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/events.py", line 88, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd897409d0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd897409d0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd897409d0>()>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/testclient.py", line 137, in run_app
    await self.app(self.scope, self._asgi_receive, self._asgi_send)
          │    │   │    │      │    │              │    └ <function WebSocketTestSession._asgi_send at 0x7efd8aefaa20>
          │    │   │    │      │    │              └ <starlette.testclient.WebSocketTestSession object at 0x7efd89746840>
          │    │   │    │      │    └ <function WebSocketTestSession._asgi_receive at 0x7efd8aefa980>
          │    │   │    │      └ <starlette.testclient.WebSocketTestSession object at 0x7efd89746840>
          │    │   │    └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    │   └ <starlette.testclient.WebSocketTestSession object at 0x7efd89746840>
          │    └ <fastapi.applications.FastAPI object at 0x7efd8ac9bf50>
          └ <starlette.testclient.WebSocketTestSession object at 0x7efd89746840>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd89746840>>
                           │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89746840>>
                           └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd89746840>>
          │    │                │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89746840>>
          │    │                └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7efd8ab62e70>
          └ <fastapi.applications.FastAPI object at 0x7efd8ac9bf50>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/errors.py", line 151, in __call__
    await self.app(scope, receive, send)
          │    │   │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd89746840>>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89746840>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <main.LoggingMiddleware object at 0x7efd8ab62e40>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7efd8ab62e70>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/base.py", line 103, in __call__
    await self.app(scope, receive, send)
          │    │   │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd89746840>>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89746840>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7efd8ab62e10>
          └ <main.LoggingMiddleware object at 0x7efd8ab62e40>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd89746840>>
          │                            │    │    │     │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89746840>>
          │                            │    │    │     └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │                            │    │    └ <starlette.websockets.WebSocket object at 0x7efd89746b10>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7efd8ab62e10>
          └ <function wrap_app_handling_exceptions at 0x7efd8ae805e0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8ab66de0>
          │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89746840>>
          │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8ab66de0>
          │    │                │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89746840>>
          │    │                └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7efd8acc75c0>>
          └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8ab66de0>
          │     │      │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89746840>>
          │     │      └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │     └ <function WebSocketRoute.handle at 0x7efd8ae81ee0>
          └ APIWebSocketRoute(path='/ws/v1/chat/completions', name='websocket_chat')
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 375, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8ab66de0>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89746840>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <function websocket_session.<locals>.app at 0x7efd8ab1e700>
          └ APIWebSocketRoute(path='/ws/v1/chat/completions', name='websocket_chat')
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 98, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8ab66de0>
          │                            │    │        │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89746840>>
          │                            │    │        └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │                            │    └ <starlette.websockets.WebSocket object at 0x7efd89746270>
          │                            └ <function websocket_session.<locals>.app.<locals>.app at 0x7efd8ab67100>
          └ <function wrap_app_handling_exceptions at 0x7efd8ae805e0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8ab66340>
          │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd89746840>>
          │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          └ <function websocket_session.<locals>.app.<locals>.app at 0x7efd8ab67100>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 96, in app
    await func(session)
          │    └ <starlette.websockets.WebSocket object at 0x7efd89746270>
          └ <function get_websocket_app.<locals>.app at 0x7efd8ab1e7a0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/fastapi/routing.py", line 348, in app
    await dependant.call(**values)
          │         │      └ {'websocket': <starlette.websockets.WebSocket object at 0x7efd89746270>}
          │         └ <function websocket_chat at 0x7efd8ab1e660>
          └ <fastapi.dependencies.models.Dependant object at 0x7efd8ab0a930>

> File "/app/main.py", line 276, in websocket_chat
    if isinstance(e, UpstreamServiceError): # If it was already one of our custom types somehow
                  └ NameError("name 'UpstreamServiceError' is not defined")

NameError: name 'UpstreamServiceError' is not defined
2025-06-30 11:03:41.441 | ERROR    | main:websocket_chat:275 - WS: Unexpected error with AI service at ai.liara.ir during stream: 'coroutine' object does not support the asynchronous context manager protocol
2025-06-30 11:03:41.441 | ERROR    | main:websocket_chat:299 - General WebSocket error for 99445680-2771-4b0b-9db1-7fc2d05c17c4: name 'UpstreamServiceError' is not defined
Traceback (most recent call last):

  File "/app/main.py", line 241, in websocket_chat
    async with client.stream(
               │      └ <AsyncMock id='139627409152752'>
               └ <httpx.AsyncClient object at 0x7efd8a149b50>

TypeError: 'coroutine' object does not support the asynchronous context manager protocol


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1032, in _bootstrap
    self._bootstrap_inner()
    │    └ <function Thread._bootstrap_inner at 0x7efd8cc80b80>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1075, in _bootstrap_inner
    self.run()
    │    └ <function Thread.run at 0x7efd8cc80860>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1012, in run
    self._target(*self._args, **self._kwargs)
    │    │        │    │        │    └ {}
    │    │        │    │        └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
    │    │        │    └ ()
    │    │        └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
    │    └ <function start_blocking_portal.<locals>.run_blocking_portal at 0x7efd8ab56ca0>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/from_thread.py", line 481, in run_blocking_portal
    _eventloop.run(
    │          └ <function run at 0x7efd8c595bc0>
    └ <module 'anyio._core._eventloop' from '/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_core/_eventloo...
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_core/_eventloop.py", line 74, in run
    return async_backend.run(func, args, {}, backend_options)
           │             │   │     │         └ {}
           │             │   │     └ ()
           │             │   └ <function start_blocking_portal.<locals>.run_portal at 0x7efd8ab56c00>
           │             └ <classmethod(<function AsyncIOBackend.run at 0x7efd8abbf2e0>)>
           └ <class 'anyio._backends._asyncio.AsyncIOBackend'>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2310, in run
    return runner.run(wrapper())
           │      │   └ <function start_blocking_portal.<locals>.run_portal at 0x7efd8ab56de0>
           │      └ <function Runner.run at 0x7efd8bd73b00>
           └ <asyncio.runners.Runner object at 0x7efd8ab5c1d0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='anyio.from_thread.start_blocking_portal.<locals>.run_portal' coro=<start_blocking_portal.<locals>.run_por...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7efd8bd716c0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7efd8ab5c1d0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 678, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7efd8bd71620>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 645, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7efd8bd73420>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 1999, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7efd8bcf3d80>
    └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd8a14a200>()>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/events.py", line 88, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd8a14a200>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd8a14a200>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd8a14a200>()>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/testclient.py", line 137, in run_app
    await self.app(self.scope, self._asgi_receive, self._asgi_send)
          │    │   │    │      │    │              │    └ <function WebSocketTestSession._asgi_send at 0x7efd8aefaa20>
          │    │   │    │      │    │              └ <starlette.testclient.WebSocketTestSession object at 0x7efd8a14a2a0>
          │    │   │    │      │    └ <function WebSocketTestSession._asgi_receive at 0x7efd8aefa980>
          │    │   │    │      └ <starlette.testclient.WebSocketTestSession object at 0x7efd8a14a2a0>
          │    │   │    └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    │   └ <starlette.testclient.WebSocketTestSession object at 0x7efd8a14a2a0>
          │    └ <fastapi.applications.FastAPI object at 0x7efd8ac9bf50>
          └ <starlette.testclient.WebSocketTestSession object at 0x7efd8a14a2a0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd8a14a2a0>>
                           │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8a14a2a0>>
                           └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd8a14a2a0>>
          │    │                │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8a14a2a0>>
          │    │                └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7efd8ab62e70>
          └ <fastapi.applications.FastAPI object at 0x7efd8ac9bf50>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/errors.py", line 151, in __call__
    await self.app(scope, receive, send)
          │    │   │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd8a14a2a0>>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8a14a2a0>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <main.LoggingMiddleware object at 0x7efd8ab62e40>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7efd8ab62e70>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/base.py", line 103, in __call__
    await self.app(scope, receive, send)
          │    │   │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd8a14a2a0>>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8a14a2a0>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7efd8ab62e10>
          └ <main.LoggingMiddleware object at 0x7efd8ab62e40>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd8a14a2a0>>
          │                            │    │    │     │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8a14a2a0>>
          │                            │    │    │     └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │                            │    │    └ <starlette.websockets.WebSocket object at 0x7efd8a149010>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7efd8ab62e10>
          └ <function wrap_app_handling_exceptions at 0x7efd8ae805e0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971cea0>
          │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8a14a2a0>>
          │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971cea0>
          │    │                │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8a14a2a0>>
          │    │                └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7efd8acc75c0>>
          └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971cea0>
          │     │      │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8a14a2a0>>
          │     │      └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │     └ <function WebSocketRoute.handle at 0x7efd8ae81ee0>
          └ APIWebSocketRoute(path='/ws/v1/chat/completions', name='websocket_chat')
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 375, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971cea0>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8a14a2a0>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <function websocket_session.<locals>.app at 0x7efd8ab1e700>
          └ APIWebSocketRoute(path='/ws/v1/chat/completions', name='websocket_chat')
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 98, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971cea0>
          │                            │    │        │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8a14a2a0>>
          │                            │    │        └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │                            │    └ <starlette.websockets.WebSocket object at 0x7efd8a149520>
          │                            └ <function websocket_session.<locals>.app.<locals>.app at 0x7efd8971cf40>
          └ <function wrap_app_handling_exceptions at 0x7efd8ae805e0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971d080>
          │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8a14a2a0>>
          │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          └ <function websocket_session.<locals>.app.<locals>.app at 0x7efd8971cf40>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 96, in app
    await func(session)
          │    └ <starlette.websockets.WebSocket object at 0x7efd8a149520>
          └ <function get_websocket_app.<locals>.app at 0x7efd8ab1e7a0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/fastapi/routing.py", line 348, in app
    await dependant.call(**values)
          │         │      └ {'websocket': <starlette.websockets.WebSocket object at 0x7efd8a149520>}
          │         └ <function websocket_chat at 0x7efd8ab1e660>
          └ <fastapi.dependencies.models.Dependant object at 0x7efd8ab0a930>

> File "/app/main.py", line 276, in websocket_chat
    if isinstance(e, UpstreamServiceError): # If it was already one of our custom types somehow
                  └ NameError("name 'UpstreamServiceError' is not defined")

NameError: name 'UpstreamServiceError' is not defined
2025-06-30 11:03:41.517 | ERROR    | main:websocket_chat:275 - WS: Unexpected error with AI service at ai.liara.ir during stream: 'coroutine' object does not support the asynchronous context manager protocol
2025-06-30 11:03:41.517 | ERROR    | main:websocket_chat:299 - General WebSocket error for 50ad3464-d890-400e-b815-ff02f995cf80: name 'UpstreamServiceError' is not defined
Traceback (most recent call last):

  File "/app/main.py", line 241, in websocket_chat
    async with client.stream(
               │      └ <AsyncMock id='139627408430512'>
               └ <httpx.AsyncClient object at 0x7efd8aaa6270>

TypeError: 'coroutine' object does not support the asynchronous context manager protocol


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1032, in _bootstrap
    self._bootstrap_inner()
    │    └ <function Thread._bootstrap_inner at 0x7efd8cc80b80>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1075, in _bootstrap_inner
    self.run()
    │    └ <function Thread.run at 0x7efd8cc80860>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1012, in run
    self._target(*self._args, **self._kwargs)
    │    │        │    │        │    └ {}
    │    │        │    │        └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
    │    │        │    └ ()
    │    │        └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
    │    └ <function start_blocking_portal.<locals>.run_blocking_portal at 0x7efd8ab56ca0>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/from_thread.py", line 481, in run_blocking_portal
    _eventloop.run(
    │          └ <function run at 0x7efd8c595bc0>
    └ <module 'anyio._core._eventloop' from '/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_core/_eventloo...
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_core/_eventloop.py", line 74, in run
    return async_backend.run(func, args, {}, backend_options)
           │             │   │     │         └ {}
           │             │   │     └ ()
           │             │   └ <function start_blocking_portal.<locals>.run_portal at 0x7efd8ab56c00>
           │             └ <classmethod(<function AsyncIOBackend.run at 0x7efd8abbf2e0>)>
           └ <class 'anyio._backends._asyncio.AsyncIOBackend'>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2310, in run
    return runner.run(wrapper())
           │      │   └ <function start_blocking_portal.<locals>.run_portal at 0x7efd8ab56de0>
           │      └ <function Runner.run at 0x7efd8bd73b00>
           └ <asyncio.runners.Runner object at 0x7efd8ab5c1d0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='anyio.from_thread.start_blocking_portal.<locals>.run_portal' coro=<start_blocking_portal.<locals>.run_por...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7efd8bd716c0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7efd8ab5c1d0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 678, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7efd8bd71620>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 645, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7efd8bd73420>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 1999, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7efd8bcf3d80>
    └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd8aaa6680>()>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/events.py", line 88, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd8aaa6680>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd8aaa6680>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd8aaa6680>()>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/testclient.py", line 137, in run_app
    await self.app(self.scope, self._asgi_receive, self._asgi_send)
          │    │   │    │      │    │              │    └ <function WebSocketTestSession._asgi_send at 0x7efd8aefaa20>
          │    │   │    │      │    │              └ <starlette.testclient.WebSocketTestSession object at 0x7efd8aaa46b0>
          │    │   │    │      │    └ <function WebSocketTestSession._asgi_receive at 0x7efd8aefa980>
          │    │   │    │      └ <starlette.testclient.WebSocketTestSession object at 0x7efd8aaa46b0>
          │    │   │    └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    │   └ <starlette.testclient.WebSocketTestSession object at 0x7efd8aaa46b0>
          │    └ <fastapi.applications.FastAPI object at 0x7efd8ac9bf50>
          └ <starlette.testclient.WebSocketTestSession object at 0x7efd8aaa46b0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd8aaa46b0>>
                           │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aaa46b0>>
                           └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd8aaa46b0>>
          │    │                │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aaa46b0>>
          │    │                └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7efd8ab62e70>
          └ <fastapi.applications.FastAPI object at 0x7efd8ac9bf50>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/errors.py", line 151, in __call__
    await self.app(scope, receive, send)
          │    │   │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd8aaa46b0>>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aaa46b0>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <main.LoggingMiddleware object at 0x7efd8ab62e40>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7efd8ab62e70>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/base.py", line 103, in __call__
    await self.app(scope, receive, send)
          │    │   │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd8aaa46b0>>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aaa46b0>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7efd8ab62e10>
          └ <main.LoggingMiddleware object at 0x7efd8ab62e40>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd8aaa46b0>>
          │                            │    │    │     │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aaa46b0>>
          │                            │    │    │     └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │                            │    │    └ <starlette.websockets.WebSocket object at 0x7efd8aaa6d80>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7efd8ab62e10>
          └ <function wrap_app_handling_exceptions at 0x7efd8ae805e0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971e020>
          │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aaa46b0>>
          │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971e020>
          │    │                │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aaa46b0>>
          │    │                └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7efd8acc75c0>>
          └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971e020>
          │     │      │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aaa46b0>>
          │     │      └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │     └ <function WebSocketRoute.handle at 0x7efd8ae81ee0>
          └ APIWebSocketRoute(path='/ws/v1/chat/completions', name='websocket_chat')
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 375, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971e020>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aaa46b0>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <function websocket_session.<locals>.app at 0x7efd8ab1e700>
          └ APIWebSocketRoute(path='/ws/v1/chat/completions', name='websocket_chat')
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 98, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971e020>
          │                            │    │        │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aaa46b0>>
          │                            │    │        └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │                            │    └ <starlette.websockets.WebSocket object at 0x7efd8aaa6ab0>
          │                            └ <function websocket_session.<locals>.app.<locals>.app at 0x7efd8971e160>
          └ <function wrap_app_handling_exceptions at 0x7efd8ae805e0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971e2a0>
          │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aaa46b0>>
          │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          └ <function websocket_session.<locals>.app.<locals>.app at 0x7efd8971e160>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 96, in app
    await func(session)
          │    └ <starlette.websockets.WebSocket object at 0x7efd8aaa6ab0>
          └ <function get_websocket_app.<locals>.app at 0x7efd8ab1e7a0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/fastapi/routing.py", line 348, in app
    await dependant.call(**values)
          │         │      └ {'websocket': <starlette.websockets.WebSocket object at 0x7efd8aaa6ab0>}
          │         └ <function websocket_chat at 0x7efd8ab1e660>
          └ <fastapi.dependencies.models.Dependant object at 0x7efd8ab0a930>

> File "/app/main.py", line 276, in websocket_chat
    if isinstance(e, UpstreamServiceError): # If it was already one of our custom types somehow
                  └ NameError("name 'UpstreamServiceError' is not defined")

NameError: name 'UpstreamServiceError' is not defined
2025-06-30 11:03:41.602 | ERROR    | main:websocket_chat:275 - WS: Unexpected error with AI service at ai.liara.ir during stream: 'coroutine' object does not support the asynchronous context manager protocol
2025-06-30 11:03:41.603 | ERROR    | main:websocket_chat:299 - General WebSocket error for 11aa8e3d-ab27-4108-931f-3f040071a448: name 'UpstreamServiceError' is not defined
Traceback (most recent call last):

  File "/app/main.py", line 241, in websocket_chat
    async with client.stream(
               │      └ <AsyncMock id='139627418199552'>
               └ <httpx.AsyncClient object at 0x7efd8ab63710>

TypeError: 'coroutine' object does not support the asynchronous context manager protocol


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1032, in _bootstrap
    self._bootstrap_inner()
    │    └ <function Thread._bootstrap_inner at 0x7efd8cc80b80>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1075, in _bootstrap_inner
    self.run()
    │    └ <function Thread.run at 0x7efd8cc80860>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1012, in run
    self._target(*self._args, **self._kwargs)
    │    │        │    │        │    └ {}
    │    │        │    │        └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
    │    │        │    └ ()
    │    │        └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
    │    └ <function start_blocking_portal.<locals>.run_blocking_portal at 0x7efd8ab56ca0>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/from_thread.py", line 481, in run_blocking_portal
    _eventloop.run(
    │          └ <function run at 0x7efd8c595bc0>
    └ <module 'anyio._core._eventloop' from '/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_core/_eventloo...
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_core/_eventloop.py", line 74, in run
    return async_backend.run(func, args, {}, backend_options)
           │             │   │     │         └ {}
           │             │   │     └ ()
           │             │   └ <function start_blocking_portal.<locals>.run_portal at 0x7efd8ab56c00>
           │             └ <classmethod(<function AsyncIOBackend.run at 0x7efd8abbf2e0>)>
           └ <class 'anyio._backends._asyncio.AsyncIOBackend'>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2310, in run
    return runner.run(wrapper())
           │      │   └ <function start_blocking_portal.<locals>.run_portal at 0x7efd8ab56de0>
           │      └ <function Runner.run at 0x7efd8bd73b00>
           └ <asyncio.runners.Runner object at 0x7efd8ab5c1d0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='anyio.from_thread.start_blocking_portal.<locals>.run_portal' coro=<start_blocking_portal.<locals>.run_por...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7efd8bd716c0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7efd8ab5c1d0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 678, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7efd8bd71620>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 645, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7efd8bd73420>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 1999, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7efd8bcf3d80>
    └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd8aa284c0>()>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/events.py", line 88, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd8aa284c0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd8aa284c0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd8aa284c0>()>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/testclient.py", line 137, in run_app
    await self.app(self.scope, self._asgi_receive, self._asgi_send)
          │    │   │    │      │    │              │    └ <function WebSocketTestSession._asgi_send at 0x7efd8aefaa20>
          │    │   │    │      │    │              └ <starlette.testclient.WebSocketTestSession object at 0x7efd8aa28f20>
          │    │   │    │      │    └ <function WebSocketTestSession._asgi_receive at 0x7efd8aefa980>
          │    │   │    │      └ <starlette.testclient.WebSocketTestSession object at 0x7efd8aa28f20>
          │    │   │    └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    │   └ <starlette.testclient.WebSocketTestSession object at 0x7efd8aa28f20>
          │    └ <fastapi.applications.FastAPI object at 0x7efd8ac9bf50>
          └ <starlette.testclient.WebSocketTestSession object at 0x7efd8aa28f20>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa28f20>>
                           │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa28f20>>
                           └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa28f20>>
          │    │                │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa28f20>>
          │    │                └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7efd8ab62e70>
          └ <fastapi.applications.FastAPI object at 0x7efd8ac9bf50>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/errors.py", line 151, in __call__
    await self.app(scope, receive, send)
          │    │   │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa28f20>>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa28f20>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <main.LoggingMiddleware object at 0x7efd8ab62e40>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7efd8ab62e70>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/base.py", line 103, in __call__
    await self.app(scope, receive, send)
          │    │   │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa28f20>>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa28f20>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7efd8ab62e10>
          └ <main.LoggingMiddleware object at 0x7efd8ab62e40>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa28f20>>
          │                            │    │    │     │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa28f20>>
          │                            │    │    │     └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │                            │    │    └ <starlette.websockets.WebSocket object at 0x7efd8ab63b60>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7efd8ab62e10>
          └ <function wrap_app_handling_exceptions at 0x7efd8ae805e0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971e8e0>
          │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa28f20>>
          │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971e8e0>
          │    │                │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa28f20>>
          │    │                └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7efd8acc75c0>>
          └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971e8e0>
          │     │      │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa28f20>>
          │     │      └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │     └ <function WebSocketRoute.handle at 0x7efd8ae81ee0>
          └ APIWebSocketRoute(path='/ws/v1/chat/completions', name='websocket_chat')
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 375, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971e8e0>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa28f20>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <function websocket_session.<locals>.app at 0x7efd8ab1e700>
          └ APIWebSocketRoute(path='/ws/v1/chat/completions', name='websocket_chat')
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 98, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971e8e0>
          │                            │    │        │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa28f20>>
          │                            │    │        └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │                            │    └ <starlette.websockets.WebSocket object at 0x7efd8ab63230>
          │                            └ <function websocket_session.<locals>.app.<locals>.app at 0x7efd8971e980>
          └ <function wrap_app_handling_exceptions at 0x7efd8ae805e0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971ccc0>
          │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa28f20>>
          │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          └ <function websocket_session.<locals>.app.<locals>.app at 0x7efd8971e980>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 96, in app
    await func(session)
          │    └ <starlette.websockets.WebSocket object at 0x7efd8ab63230>
          └ <function get_websocket_app.<locals>.app at 0x7efd8ab1e7a0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/fastapi/routing.py", line 348, in app
    await dependant.call(**values)
          │         │      └ {'websocket': <starlette.websockets.WebSocket object at 0x7efd8ab63230>}
          │         └ <function websocket_chat at 0x7efd8ab1e660>
          └ <fastapi.dependencies.models.Dependant object at 0x7efd8ab0a930>

> File "/app/main.py", line 276, in websocket_chat
    if isinstance(e, UpstreamServiceError): # If it was already one of our custom types somehow
                  └ NameError("name 'UpstreamServiceError' is not defined")

NameError: name 'UpstreamServiceError' is not defined
2025-06-30 11:03:41.680 | ERROR    | main:websocket_chat:299 - General WebSocket error for 3c5b12d6-13cd-4fc8-ad77-0bee4d426cec: name 'UpstreamServiceError' is not defined
Traceback (most recent call last):

  File "/app/main.py", line 241, in websocket_chat
    async with client.stream(
               │      └ <AsyncMock id='139627417699536'>
               └ <httpx.AsyncClient object at 0x7efd8aa3a630>

TypeError: 'coroutine' object does not support the asynchronous context manager protocol


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1032, in _bootstrap
    self._bootstrap_inner()
    │    └ <function Thread._bootstrap_inner at 0x7efd8cc80b80>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1075, in _bootstrap_inner
    self.run()
    │    └ <function Thread.run at 0x7efd8cc80860>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1012, in run
    self._target(*self._args, **self._kwargs)
    │    │        │    │        │    └ {}
    │    │        │    │        └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
    │    │        │    └ ()
    │    │        └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
    │    └ <function start_blocking_portal.<locals>.run_blocking_portal at 0x7efd8ab56ca0>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 139627417568960)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/from_thread.py", line 481, in run_blocking_portal
    _eventloop.run(
    │          └ <function run at 0x7efd8c595bc0>
    └ <module 'anyio._core._eventloop' from '/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_core/_eventloo...
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_core/_eventloop.py", line 74, in run
    return async_backend.run(func, args, {}, backend_options)
           │             │   │     │         └ {}
           │             │   │     └ ()
           │             │   └ <function start_blocking_portal.<locals>.run_portal at 0x7efd8ab56c00>
           │             └ <classmethod(<function AsyncIOBackend.run at 0x7efd8abbf2e0>)>
           └ <class 'anyio._backends._asyncio.AsyncIOBackend'>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2310, in run
    return runner.run(wrapper())
           │      │   └ <function start_blocking_portal.<locals>.run_portal at 0x7efd8ab56de0>
           │      └ <function Runner.run at 0x7efd8bd73b00>
           └ <asyncio.runners.Runner object at 0x7efd8ab5c1d0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='anyio.from_thread.start_blocking_portal.<locals>.run_portal' coro=<start_blocking_portal.<locals>.run_por...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7efd8bd716c0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7efd8ab5c1d0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 678, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7efd8bd71620>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 645, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7efd8bd73420>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 1999, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7efd8bcf3d80>
    └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd8aa3ad40>()>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/events.py", line 88, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd8aa3ad40>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd8aa3ad40>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7efd8aa3ad40>()>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/testclient.py", line 137, in run_app
    await self.app(self.scope, self._asgi_receive, self._asgi_send)
          │    │   │    │      │    │              │    └ <function WebSocketTestSession._asgi_send at 0x7efd8aefaa20>
          │    │   │    │      │    │              └ <starlette.testclient.WebSocketTestSession object at 0x7efd8aa39f10>
          │    │   │    │      │    └ <function WebSocketTestSession._asgi_receive at 0x7efd8aefa980>
          │    │   │    │      └ <starlette.testclient.WebSocketTestSession object at 0x7efd8aa39f10>
          │    │   │    └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    │   └ <starlette.testclient.WebSocketTestSession object at 0x7efd8aa39f10>
          │    └ <fastapi.applications.FastAPI object at 0x7efd8ac9bf50>
          └ <starlette.testclient.WebSocketTestSession object at 0x7efd8aa39f10>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa39f10>>
                           │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa39f10>>
                           └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa39f10>>
          │    │                │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa39f10>>
          │    │                └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7efd8ab62e70>
          └ <fastapi.applications.FastAPI object at 0x7efd8ac9bf50>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/errors.py", line 151, in __call__
    await self.app(scope, receive, send)
          │    │   │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa39f10>>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa39f10>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <main.LoggingMiddleware object at 0x7efd8ab62e40>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7efd8ab62e70>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/base.py", line 103, in __call__
    await self.app(scope, receive, send)
          │    │   │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa39f10>>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa39f10>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7efd8ab62e10>
          └ <main.LoggingMiddleware object at 0x7efd8ab62e40>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa39f10>>
          │                            │    │    │     │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa39f10>>
          │                            │    │    │     └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │                            │    │    └ <starlette.websockets.WebSocket object at 0x7efd8aa3b620>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7efd8ab62e10>
          └ <function wrap_app_handling_exceptions at 0x7efd8ae805e0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971f060>
          │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa39f10>>
          │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971f060>
          │    │                │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa39f10>>
          │    │                └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7efd8acc75c0>>
          └ <fastapi.routing.APIRouter object at 0x7efd8acc75c0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971f060>
          │     │      │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa39f10>>
          │     │      └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │     └ <function WebSocketRoute.handle at 0x7efd8ae81ee0>
          └ APIWebSocketRoute(path='/ws/v1/chat/completions', name='websocket_chat')
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 375, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971f060>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa39f10>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <function websocket_session.<locals>.app at 0x7efd8ab1e700>
          └ APIWebSocketRoute(path='/ws/v1/chat/completions', name='websocket_chat')
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 98, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971f060>
          │                            │    │        │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa39f10>>
          │                            │    │        └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │                            │    └ <starlette.websockets.WebSocket object at 0x7efd8aa3b590>
          │                            └ <function websocket_session.<locals>.app.<locals>.app at 0x7efd8971f100>
          └ <function wrap_app_handling_exceptions at 0x7efd8ae805e0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7efd8971f2e0>
          │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7efd8aa39f10>>
          │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          └ <function websocket_session.<locals>.app.<locals>.app at 0x7efd8971f100>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 96, in app
    await func(session)
          │    └ <starlette.websockets.WebSocket object at 0x7efd8aa3b590>
          └ <function get_websocket_app.<locals>.app at 0x7efd8ab1e7a0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/fastapi/routing.py", line 348, in app
    await dependant.call(**values)
          │         │      └ {'websocket': <starlette.websockets.WebSocket object at 0x7efd8aa3b590>}
          │         └ <function websocket_chat at 0x7efd8ab1e660>
          └ <fastapi.dependencies.models.Dependant object at 0x7efd8ab0a930>

> File "/app/main.py", line 276, in websocket_chat
    if isinstance(e, UpstreamServiceError): # If it was already one of our custom types somehow
                  └ NameError("name 'UpstreamServiceError' is not defined")

NameError: name 'UpstreamServiceError' is not defined
2025-06-30 11:09:35.346 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:09:35.349 | WARNING  | main:http_exception_handler:116 - HTTPException: API Key is required in Authorization header
2025-06-30 11:09:35.349 | INFO     | main:dispatch:107 - Response: 401 (3.14ms)
2025-06-30 11:09:35.356 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:09:35.358 | WARNING  | main:http_exception_handler:116 - HTTPException: API Key is required in Authorization header
2025-06-30 11:09:35.358 | INFO     | main:dispatch:107 - Response: 401 (1.67ms)
2025-06-30 11:09:35.365 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:09:35.430 | INFO     | main:dispatch:107 - Response: 200 (64.77ms)
2025-06-30 11:09:35.438 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:09:35.440 | INFO     | main:chat_completions:144 - Cache hit
2025-06-30 11:09:35.440 | INFO     | main:dispatch:107 - Response: 200 (1.94ms)
2025-06-30 11:09:35.445 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:09:35.486 | WARNING  | main:chat_completions:181 - Could not connect to upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b844028900: Connection failed to first server
2025-06-30 11:09:35.542 | INFO     | main:dispatch:107 - Response: 200 (96.42ms)
2025-06-30 11:09:35.551 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:09:35.593 | WARNING  | main:chat_completions:181 - Could not connect to upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b844028900: Connection failed to server 0
2025-06-30 11:09:35.634 | WARNING  | main:chat_completions:181 - Could not connect to upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d300: Connection failed to server 1
2025-06-30 11:09:35.676 | WARNING  | main:chat_completions:181 - Could not connect to upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d300: Connection failed to server 2
2025-06-30 11:09:35.677 | WARNING  | main:http_exception_handler:116 - HTTPException: Could not connect to AI service endpoint: https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d300. It may be temporarily down.
2025-06-30 11:09:35.677 | INFO     | main:dispatch:107 - Response: 503 (125.87ms)
2025-06-30 11:09:35.685 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:09:35.730 | WARNING  | main:chat_completions:164 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b844028900 returned error: 429 - Liara specific error
2025-06-30 11:09:35.781 | WARNING  | main:chat_completions:164 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d300 returned error: 429 - Liara specific error
2025-06-30 11:09:35.825 | WARNING  | main:chat_completions:164 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d300 returned error: 429 - Liara specific error
2025-06-30 11:09:35.826 | WARNING  | main:http_exception_handler:116 - HTTPException: An unexpected error occurred while contacting AI service: https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d300.
2025-06-30 11:09:35.826 | INFO     | main:dispatch:107 - Response: 500 (140.79ms)
2025-06-30 11:09:35.915 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:09:35.959 | ERROR    | main:dispatch:101 - Unhandled exception: UpstreamResponseError.__init__() got an unexpected keyword argument 'upstream_status_code'
Traceback (most recent call last):

  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    message = await recv_stream.receive()
                    │           └ <function MemoryObjectReceiveStream.receive at 0x7fc7af5ec2c0>
                    └ MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_rece...
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/streams/memory.py", line 126, in receive
    raise EndOfStream from None
          └ <class 'anyio.EndOfStream'>

anyio.EndOfStream


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1032, in _bootstrap
    self._bootstrap_inner()
    │    └ <function Thread._bootstrap_inner at 0x7fc7b0468b80>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 140495598651072)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1075, in _bootstrap_inner
    self.run()
    │    └ <function Thread.run at 0x7fc7b0468860>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 140495598651072)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1012, in run
    self._target(*self._args, **self._kwargs)
    │    │        │    │        │    └ {}
    │    │        │    │        └ <Thread(Thread-2 (run_blocking_portal), started daemon 140495598651072)>
    │    │        │    └ ()
    │    │        └ <Thread(Thread-2 (run_blocking_portal), started daemon 140495598651072)>
    │    └ <function start_blocking_portal.<locals>.run_blocking_portal at 0x7fc7ae592d40>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 140495598651072)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/from_thread.py", line 481, in run_blocking_portal
    _eventloop.run(
    │          └ <function run at 0x7fc7affb1bc0>
    └ <module 'anyio._core._eventloop' from '/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_core/_eventloo...
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_core/_eventloop.py", line 74, in run
    return async_backend.run(func, args, {}, backend_options)
           │             │   │     │         └ {}
           │             │   │     └ ()
           │             │   └ <function start_blocking_portal.<locals>.run_portal at 0x7fc7ae592ca0>
           │             └ <classmethod(<function AsyncIOBackend.run at 0x7fc7ae5fb380>)>
           └ <class 'anyio._backends._asyncio.AsyncIOBackend'>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2310, in run
    return runner.run(wrapper())
           │      │   └ <function start_blocking_portal.<locals>.run_portal at 0x7fc7ae592e80>
           │      └ <function Runner.run at 0x7fc7af78bb00>
           └ <asyncio.runners.Runner object at 0x7fc7ae598e90>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='anyio.from_thread.start_blocking_portal.<locals>.run_portal' coro=<start_blocking_portal.<locals>.run_por...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7fc7af7896c0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7fc7ae598e90>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 678, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7fc7af789620>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 645, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7fc7af78b420>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 1999, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7fc7af70fd80>
    └ <Handle Task.task_wakeup(<Future finished result=True>)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/events.py", line 88, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle Task.task_wakeup(<Future finished result=True>)>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle Task.task_wakeup(<Future finished result=True>)>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle Task.task_wakeup(<Future finished result=True>)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
                   └ <coroutine object FastAPI.__call__ at 0x7fc7ae54f790>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <function _TestClientTransport.handle_request.<locals>.send at 0x7fc7ae5a2d40>
                           │      └ <function _TestClientTransport.handle_request.<locals>.receive at 0x7fc7ae5a1ee0>
                           └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function _TestClientTransport.handle_request.<locals>.send at 0x7fc7ae5a2d40>
          │    │                │      └ <function _TestClientTransport.handle_request.<locals>.receive at 0x7fc7ae5a1ee0>
          │    │                └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7fc7ae59ede0>
          └ <fastapi.applications.FastAPI object at 0x7fc7af5c92b0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7fc7ae5a3060>
          │    │   │      └ <function _TestClientTransport.handle_request.<locals>.receive at 0x7fc7ae5a1ee0>
          │    │   └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
          │    └ <main.LoggingMiddleware object at 0x7fc7ae59edb0>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7fc7ae59ede0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    response = await self.dispatch_func(request, call_next)
                     │    │             │        └ <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7fc7ae5a2e80>
                     │    │             └ <starlette.middleware.base._CachedRequest object at 0x7fc7ae4e7080>
                     │    └ <bound method LoggingMiddleware.dispatch of <main.LoggingMiddleware object at 0x7fc7ae59edb0>>
                     └ <main.LoggingMiddleware object at 0x7fc7ae59edb0>

> File "/app/main.py", line 99, in dispatch
    response = await call_next(request)
                     │         └ <starlette.middleware.base._CachedRequest object at 0x7fc7ae4e7080>
                     └ <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7fc7ae5a2e80>

  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/base.py", line 165, in call_next
    raise app_exc
          └ TypeError("UpstreamResponseError.__init__() got an unexpected keyword argument 'upstream_status_code'")
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/base.py", line 151, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
          │    │   │      │                      └ <function BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.send_no_error at 0x7fc7ae5a34c0>
          │    │   │      └ <function BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.receive_or_disconnect at 0x7fc7ae5a2a20>
          │    │   └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7fc7ae59ed80>
          └ <main.LoggingMiddleware object at 0x7fc7ae59edb0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ <function BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.send_no_error at 0x7fc7ae5a34c0>
          │                            │    │    │     │      └ <function BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.receive_or_disconnect at 0x7fc7ae5a2a20>
          │                            │    │    │     └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
          │                            │    │    └ <starlette.requests.Request object at 0x7fc7ae4e7410>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7fc7af540cb0>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7fc7ae59ed80>
          └ <function wrap_app_handling_exceptions at 0x7fc7ae8ac680>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 64, in wrapped_app
    raise exc
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7fc7ae4d51c0>
          │   │      └ <function BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.receive_or_disconnect at 0x7fc7ae5a2a20>
          │   └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
          └ <fastapi.routing.APIRouter object at 0x7fc7af540cb0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7fc7ae4d51c0>
          │    │                │      └ <function BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.receive_or_disconnect at 0x7fc7ae5a2a20>
          │    │                └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7fc7af540cb0>>
          └ <fastapi.routing.APIRouter object at 0x7fc7af540cb0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7fc7ae4d51c0>
          │     │      │      └ <function BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.receive_or_disconnect at 0x7fc7ae5a2a20>
          │     │      └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
          │     └ <function Route.handle at 0x7fc7ae8adb20>
          └ APIRoute(path='/api/v1/chat/completions', name='chat_completions', methods=['POST'])
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7fc7ae4d51c0>
          │    │   │      └ <function BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.receive_or_disconnect at 0x7fc7ae5a2a20>
          │    │   └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
          │    └ <function request_response.<locals>.app at 0x7fc7ae556480>
          └ APIRoute(path='/api/v1/chat/completions', name='chat_completions', methods=['POST'])
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7fc7ae4d51c0>
          │                            │    │        │      └ <function BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.receive_or_disconnect at 0x7fc7ae5a2a20>
          │                            │    │        └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
          │                            │    └ <starlette.requests.Request object at 0x7fc7ae4e7650>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7fc7ae4d5260>
          └ <function wrap_app_handling_exceptions at 0x7fc7ae8ac680>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 64, in wrapped_app
    raise exc
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7fc7ae4d53a0>
          │   │      └ <function BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.receive_or_disconnect at 0x7fc7ae5a2a20>
          │   └ {'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/api/v1/chat/completions', 'raw_path': b'/api/v1/chat/comp...
          └ <function request_response.<locals>.app.<locals>.app at 0x7fc7ae4d5260>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7fc7ae4e7650>
                     └ <function get_request_handler.<locals>.app at 0x7fc7ae5565c0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7fc7ae8ac220>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'body': CompletionRequest(model='openai/gpt-4o-mini', messages=[Message(role='user', content='Hello', name=None, tool_calls=...
                 │         └ <function chat_completions at 0x7fc7ae556660>
                 └ <fastapi.dependencies.models.Dependant object at 0x7fc7ae547020>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/slowapi/extension.py", line 730, in async_wrapper
    response = await func(*args, **kwargs)  # type: ignore
                     │     │       └ {'body': CompletionRequest(model='openai/gpt-4o-mini', messages=[Message(role='user', content='Hello', name=None, tool_calls=...
                     │     └ ()
                     └ <function chat_completions at 0x7fc7ae556520>

  File "/app/main.py", line 187, in chat_completions
    last_exception = UpstreamResponseError(
                     └ <class 'errors.UpstreamResponseError'>

TypeError: UpstreamResponseError.__init__() got an unexpected keyword argument 'upstream_status_code'
2025-06-30 11:09:36.029 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:09:36.073 | INFO     | main:dispatch:107 - Response: 200 (43.37ms)
2025-06-30 11:09:36.079 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:09:36.081 | INFO     | main:dispatch:107 - Response: 422 (2.01ms)
2025-06-30 11:09:36.085 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:09:36.087 | INFO     | main:dispatch:107 - Response: 422 (1.40ms)
2025-06-30 11:09:36.092 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:09:36.095 | WARNING  | main:http_exception_handler:116 - HTTPException: All AI service endpoints are currently unavailable or failed.
2025-06-30 11:09:36.095 | INFO     | main:dispatch:107 - Response: 503 (3.01ms)
2025-06-30 11:09:36.101 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:09:36.144 | INFO     | main:dispatch:107 - Response: 200 (43.22ms)
2025-06-30 11:09:36.151 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:09:36.195 | INFO     | main:dispatch:107 - Response: 200 (43.31ms)
2025-06-30 11:09:36.199 | INFO     | main:dispatch:95 - Request: POST http://testserver/api/v1/chat/completions
2025-06-30 11:09:36.245 | INFO     | main:dispatch:107 - Response: 200 (45.29ms)
2025-06-30 11:09:36.300 | ERROR    | main:websocket_chat:275 - WS: Unexpected error with AI service at ai.liara.ir during stream: 'coroutine' object does not support the asynchronous context manager protocol
2025-06-30 11:09:36.301 | ERROR    | main:websocket_chat:299 - General WebSocket error for 2eea49cb-6f90-4293-9438-df11be2a1574: name 'UpstreamServiceError' is not defined
Traceback (most recent call last):

  File "/app/main.py", line 241, in websocket_chat
    async with client.stream(
               │      └ <AsyncMock id='140495578879360'>
               └ <httpx.AsyncClient object at 0x7fc7ad125cd0>

TypeError: 'coroutine' object does not support the asynchronous context manager protocol


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1032, in _bootstrap
    self._bootstrap_inner()
    │    └ <function Thread._bootstrap_inner at 0x7fc7b0468b80>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 140495598651072)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1075, in _bootstrap_inner
    self.run()
    │    └ <function Thread.run at 0x7fc7b0468860>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 140495598651072)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/threading.py", line 1012, in run
    self._target(*self._args, **self._kwargs)
    │    │        │    │        │    └ {}
    │    │        │    │        └ <Thread(Thread-2 (run_blocking_portal), started daemon 140495598651072)>
    │    │        │    └ ()
    │    │        └ <Thread(Thread-2 (run_blocking_portal), started daemon 140495598651072)>
    │    └ <function start_blocking_portal.<locals>.run_blocking_portal at 0x7fc7ae592d40>
    └ <Thread(Thread-2 (run_blocking_portal), started daemon 140495598651072)>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/from_thread.py", line 481, in run_blocking_portal
    _eventloop.run(
    │          └ <function run at 0x7fc7affb1bc0>
    └ <module 'anyio._core._eventloop' from '/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_core/_eventloo...
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_core/_eventloop.py", line 74, in run
    return async_backend.run(func, args, {}, backend_options)
           │             │   │     │         └ {}
           │             │   │     └ ()
           │             │   └ <function start_blocking_portal.<locals>.run_portal at 0x7fc7ae592ca0>
           │             └ <classmethod(<function AsyncIOBackend.run at 0x7fc7ae5fb380>)>
           └ <class 'anyio._backends._asyncio.AsyncIOBackend'>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2310, in run
    return runner.run(wrapper())
           │      │   └ <function start_blocking_portal.<locals>.run_portal at 0x7fc7ae592e80>
           │      └ <function Runner.run at 0x7fc7af78bb00>
           └ <asyncio.runners.Runner object at 0x7fc7ae598e90>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='anyio.from_thread.start_blocking_portal.<locals>.run_portal' coro=<start_blocking_portal.<locals>.run_por...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7fc7af7896c0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7fc7ae598e90>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 678, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7fc7af789620>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 645, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7fc7af78b420>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/base_events.py", line 1999, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7fc7af70fd80>
    └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7fc7ad1246a0>()>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/asyncio/events.py", line 88, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7fc7ad1246a0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7fc7ad1246a0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <_asyncio.TaskStepMethWrapper object at 0x7fc7ad1246a0>()>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/testclient.py", line 137, in run_app
    await self.app(self.scope, self._asgi_receive, self._asgi_send)
          │    │   │    │      │    │              │    └ <function WebSocketTestSession._asgi_send at 0x7fc7ae726ac0>
          │    │   │    │      │    │              └ <starlette.testclient.WebSocketTestSession object at 0x7fc7ad1242f0>
          │    │   │    │      │    └ <function WebSocketTestSession._asgi_receive at 0x7fc7ae726a20>
          │    │   │    │      └ <starlette.testclient.WebSocketTestSession object at 0x7fc7ad1242f0>
          │    │   │    └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    │   └ <starlette.testclient.WebSocketTestSession object at 0x7fc7ad1242f0>
          │    └ <fastapi.applications.FastAPI object at 0x7fc7af5c92b0>
          └ <starlette.testclient.WebSocketTestSession object at 0x7fc7ad1242f0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7fc7ad1242f0>>
                           │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7fc7ad1242f0>>
                           └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7fc7ad1242f0>>
          │    │                │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7fc7ad1242f0>>
          │    │                └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7fc7ae59ede0>
          └ <fastapi.applications.FastAPI object at 0x7fc7af5c92b0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/errors.py", line 151, in __call__
    await self.app(scope, receive, send)
          │    │   │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7fc7ad1242f0>>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7fc7ad1242f0>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <main.LoggingMiddleware object at 0x7fc7ae59edb0>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7fc7ae59ede0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/base.py", line 103, in __call__
    await self.app(scope, receive, send)
          │    │   │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7fc7ad1242f0>>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7fc7ad1242f0>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7fc7ae59ed80>
          └ <main.LoggingMiddleware object at 0x7fc7ae59edb0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ <bound method WebSocketTestSession._asgi_send of <starlette.testclient.WebSocketTestSession object at 0x7fc7ad1242f0>>
          │                            │    │    │     │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7fc7ad1242f0>>
          │                            │    │    │     └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │                            │    │    └ <starlette.websockets.WebSocket object at 0x7fc7ad125a00>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7fc7af540cb0>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7fc7ae59ed80>
          └ <function wrap_app_handling_exceptions at 0x7fc7ae8ac680>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7fc7ae5a1da0>
          │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7fc7ad1242f0>>
          │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          └ <fastapi.routing.APIRouter object at 0x7fc7af540cb0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7fc7ae5a1da0>
          │    │                │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7fc7ad1242f0>>
          │    │                └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7fc7af540cb0>>
          └ <fastapi.routing.APIRouter object at 0x7fc7af540cb0>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7fc7ae5a1da0>
          │     │      │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7fc7ad1242f0>>
          │     │      └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │     └ <function WebSocketRoute.handle at 0x7fc7ae8adf80>
          └ APIWebSocketRoute(path='/ws/v1/chat/completions', name='websocket_chat')
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 375, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7fc7ae5a1da0>
          │    │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7fc7ad1242f0>>
          │    │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │    └ <function websocket_session.<locals>.app at 0x7fc7ae5567a0>
          └ APIWebSocketRoute(path='/ws/v1/chat/completions', name='websocket_chat')
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 98, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7fc7ae5a1da0>
          │                            │    │        │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7fc7ad1242f0>>
          │                            │    │        └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          │                            │    └ <starlette.websockets.WebSocket object at 0x7fc7ad125f10>
          │                            └ <function websocket_session.<locals>.app.<locals>.app at 0x7fc7ae5a1440>
          └ <function wrap_app_handling_exceptions at 0x7fc7ae8ac680>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7fc7ae5a32e0>
          │   │      └ <bound method WebSocketTestSession._asgi_receive of <starlette.testclient.WebSocketTestSession object at 0x7fc7ad1242f0>>
          │   └ {'type': 'websocket', 'path': '/ws/v1/chat/completions', 'raw_path': b'/ws/v1/chat/completions', 'root_path': '', 'scheme': '...
          └ <function websocket_session.<locals>.app.<locals>.app at 0x7fc7ae5a1440>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/starlette/routing.py", line 96, in app
    await func(session)
          │    └ <starlette.websockets.WebSocket object at 0x7fc7ad125f10>
          └ <function get_websocket_app.<locals>.app at 0x7fc7ae556840>
  File "/home/jules/.pyenv/versions/3.12.11/lib/python3.12/site-packages/fastapi/routing.py", line 348, in app
    await dependant.call(**values)
          │         │      └ {'websocket': <starlette.websockets.WebSocket object at 0x7fc7ad125f10>}
          │         └ <function websocket_chat at 0x7fc7ae556700>
          └ <fastapi.dependencies.models.Dependant object at 0x7fc7ae546990>

> File "/app/main.py", line 276, in websocket_chat
    if isinstance(e, UpstreamServiceError): # If it was already one of our custom types somehow
                  └ NameError("name 'UpstreamServiceError' is not defined")

NameError: name 'UpstreamServiceError' is not defined
2025-07-03 03:55:24.824 | INFO     | main:<module>:207 - Cache initialized with maxsize: 2000
2025-07-03 03:56:10.892 | INFO     | main:<module>:128 - Cache initialized with maxsize: 2000
2025-07-03 03:56:57.438 | INFO     | main:<module>:128 - Cache initialized with maxsize: 2000
2025-07-03 03:56:57.494 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 03:56:57.497 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139844793280384'> - <AsyncMock name='mock.__aenter__().post().text' id='139844802810592'>
2025-07-03 03:56:57.500 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139844793280384'> - <AsyncMock name='mock.__aenter__().post().text' id='139844802810592'>
2025-07-03 03:56:57.573 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 03:56:57.576 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139844793017232'> - <AsyncMock name='mock.__aenter__().post().text' id='139844793014976'>
2025-07-03 03:56:57.577 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139844793017232'> - <AsyncMock name='mock.__aenter__().post().text' id='139844793014976'>
2025-07-03 03:56:57.603 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 03:56:57.606 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139844792901248'> - <AsyncMock name='mock.__aenter__().post().text' id='139844792898992'>
2025-07-03 03:56:57.607 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139844792901248'> - <AsyncMock name='mock.__aenter__().post().text' id='139844792898992'>
2025-07-03 03:56:57.634 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 03:56:57.638 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139844792745520'> - <AsyncMock name='mock.__aenter__().post().text' id='139844793121200'>
2025-07-03 03:56:57.639 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139844792745520'> - <AsyncMock name='mock.__aenter__().post().text' id='139844793121200'>
2025-07-03 03:56:57.666 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 03:56:57.669 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139844792863584'> - <AsyncMock name='mock.__aenter__().post().text' id='139844792989552'>
2025-07-03 03:56:57.670 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139844792863584'> - <AsyncMock name='mock.__aenter__().post().text' id='139844792989552'>
2025-07-03 03:56:57.684 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 16683c4e611f904c808f5a0156808cea0ad7dfd74028da03527f7dfc6964b29a
2025-07-03 03:56:57.687 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139844793092816'> - <AsyncMock name='mock.__aenter__().post().text' id='139844793109728'>
2025-07-03 03:56:57.688 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139844793092816'> - <AsyncMock name='mock.__aenter__().post().text' id='139844793109728'>
2025-07-03 03:58:06.523 | INFO     | main:<module>:128 - Cache initialized with maxsize: 2000
2025-07-03 03:58:06.580 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 03:58:06.583 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='140093309893184'> - <AsyncMock name='mock.__aenter__().post().text' id='140093309937872'>
2025-07-03 03:58:06.584 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='140093309893184'> - <AsyncMock name='mock.__aenter__().post().text' id='140093309937872'>
2025-07-03 03:58:06.660 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 03:58:06.663 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='140093309639552'> - <AsyncMock name='mock.__aenter__().post().text' id='140093309646848'>
2025-07-03 03:58:06.664 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='140093309639552'> - <AsyncMock name='mock.__aenter__().post().text' id='140093309646848'>
2025-07-03 03:58:06.692 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 03:58:06.695 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='140093309624224'> - <AsyncMock name='mock.__aenter__().post().text' id='140093309617888'>
2025-07-03 03:58:06.696 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='140093309624224'> - <AsyncMock name='mock.__aenter__().post().text' id='140093309617888'>
2025-07-03 03:58:06.723 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 03:58:06.726 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='140093309387408'> - <AsyncMock name='mock.__aenter__().post().text' id='140093320396880'>
2025-07-03 03:58:06.727 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='140093309387408'> - <AsyncMock name='mock.__aenter__().post().text' id='140093320396880'>
2025-07-03 03:58:06.756 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 03:58:06.759 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='140093309511120'> - <AsyncMock name='mock.__aenter__().post().text' id='140093309557872'>
2025-07-03 03:58:06.760 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='140093309511120'> - <AsyncMock name='mock.__aenter__().post().text' id='140093309557872'>
2025-07-03 03:59:05.757 | INFO     | main:<module>:128 - Cache initialized with maxsize: 2000
2025-07-03 03:59:05.816 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 03:59:05.819 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139797481126224'> - <AsyncMock name='mock.__aenter__().post().text' id='139797480723936'>
2025-07-03 03:59:05.820 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139797481126224'> - <AsyncMock name='mock.__aenter__().post().text' id='139797480723936'>
2025-07-03 03:59:05.898 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 03:59:05.900 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139797480859040'> - <AsyncMock name='mock.__aenter__().post().text' id='139797480862688'>
2025-07-03 03:59:05.901 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139797480859040'> - <AsyncMock name='mock.__aenter__().post().text' id='139797480862688'>
2025-07-03 03:59:05.929 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 03:59:05.932 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139797480726912'> - <AsyncMock name='mock.__aenter__().post().text' id='139797485919056'>
2025-07-03 03:59:05.933 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139797480726912'> - <AsyncMock name='mock.__aenter__().post().text' id='139797485919056'>
2025-07-03 03:59:05.961 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 03:59:05.964 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139797480612560'> - <AsyncMock name='mock.__aenter__().post().text' id='139797481844480'>
2025-07-03 03:59:05.964 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139797480612560'> - <AsyncMock name='mock.__aenter__().post().text' id='139797481844480'>
2025-07-03 03:59:05.994 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 03:59:05.997 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139797480716240'> - <AsyncMock name='mock.__aenter__().post().text' id='139797480663872'>
2025-07-03 03:59:05.998 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 returned error: <AsyncMock name='mock.__aenter__().post().status_code' id='139797480716240'> - <AsyncMock name='mock.__aenter__().post().text' id='139797480663872'>
2025-07-03 03:59:26.795 | INFO     | main:<module>:128 - Cache initialized with maxsize: 2000
2025-07-03 03:59:26.827 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 03:59:26.828 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e returned error: 500 - Internal Server Error from Upstream
2025-07-03 03:59:26.828 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 returned error: 500 - Internal Server Error from Upstream
2025-07-03 03:59:41.432 | INFO     | main:<module>:128 - Cache initialized with maxsize: 2000
2025-07-03 03:59:41.456 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 03:59:41.457 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e returned error: 500 - Internal Server Error from Upstream
2025-07-03 03:59:41.457 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 returned error: 500 - Internal Server Error from Upstream
2025-07-03 04:00:23.923 | INFO     | main:<module>:128 - Cache initialized with maxsize: 2000
2025-07-03 04:00:23.981 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 04:00:23.982 | INFO     | main:_handle_chat_completions_request:190 - Successfully fetched from https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e and cached key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 04:00:23.987 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 04:00:23.987 | WARNING  | main:_handle_chat_completions_request:197 - Request to upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e timed out: Simulated timeout
2025-07-03 04:00:23.988 | INFO     | main:_handle_chat_completions_request:190 - Successfully fetched from https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 and cached key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 04:00:23.993 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 04:00:23.994 | WARNING  | main:_handle_chat_completions_request:197 - Request to upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e timed out: Simulated timeout
2025-07-03 04:00:23.994 | WARNING  | main:_handle_chat_completions_request:197 - Request to upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 timed out: Simulated timeout
2025-07-03 04:00:23.998 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 04:00:23.998 | WARNING  | main:_handle_chat_completions_request:199 - Could not connect to upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e: Simulated connect error
2025-07-03 04:00:23.999 | WARNING  | main:_handle_chat_completions_request:199 - Could not connect to upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4: Simulated connect error
2025-07-03 04:00:24.003 | INFO     | main:_handle_chat_completions_request:181 - Cache miss for key: 1f03f7403d6379de28b1b84081a60ec23da8515172f3a040954135adcfa6e5a2
2025-07-03 04:00:24.003 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb8eb153623bd82f7d38e returned error: 500 - Internal Server Error from Upstream
2025-07-03 04:00:24.004 | WARNING  | main:_handle_chat_completions_request:193 - Upstream service at https://ai.liara.ir/api/v1/682bb6c5009ad8b8440289b4 returned error: 500 - Internal Server Error from Upstream
